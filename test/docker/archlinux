FROM archlinux/base

RUN pacman -Sy --noconfirm archlinux-keyring
RUN pacman -Syu --noconfirm
RUN pacman -S --noconfirm \
           cmake \
           gcc \
           git \
           make \
           man-db \
           python \
           python-dateutil

# Setup language environment
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8
ENV MAN_DISABLE_SECCOMP 1

# Setup timewarrior
ADD . /root/code/
WORKDIR /root/code/
RUN git clean -dfx
RUN git submodule init
RUN git submodule update
RUN cmake -DCMAKE_BUILD_TYPE=debug .
RUN make -j2
RUN make install
RUN make -j2 test || true
RUN timew --version

# Setup tests
WORKDIR /root/code/test/

CMD ["bash", "-c", "cat all.log | grep 'not ok' ; ./problems"]
